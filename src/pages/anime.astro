---
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import { sidebarLayoutConfig, siteConfig } from "../config";
import localAnimeList from "../data/anime";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥ç•ªå‰§é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.anime) {
	return Astro.redirect("/404/");
}

const isBothSidebarMode = sidebarLayoutConfig.position === "both";
const BANGUMI_USER_ID = siteConfig.bangumi?.userId || "your-user-id";
const BANGUMI_API_BASE = "https://api.bgm.tv";
const ANIME_MODE = siteConfig.anime?.mode || "bangumi";

// --- [åŸæœ‰å‡½æ•°ä¿æŒä¸å˜] ---
async function fetchSubjectPersons(subjectId: number) { /* ... */ }
async function fetchBangumiCollection(userId: string, subjectType: number, type: number) { /* ... */ }
async function processBangumiData(data: any, status: string) { /* ... */ }

// è·å–æ•°æ®
let animeList: typeof localAnimeList = [];
if (ANIME_MODE === "local") {
	animeList = localAnimeList;
} else {
	const watchingData = await fetchBangumiCollection(BANGUMI_USER_ID, 2, 3);
	const plannedData = await fetchBangumiCollection(BANGUMI_USER_ID, 2, 1);
	const completedData = await fetchBangumiCollection(BANGUMI_USER_ID, 2, 2);
	const onHoldData = await fetchBangumiCollection(BANGUMI_USER_ID, 2, 4);
	const droppedData = await fetchBangumiCollection(BANGUMI_USER_ID, 2, 5);

	const watchingList = watchingData ? await processBangumiData(watchingData, "watching") : [];
	const plannedList = plannedData ? await processBangumiData(plannedData, "planned") : [];
	const completedList = completedData ? await processBangumiData(completedData, "completed") : [];
	const onHoldList = onHoldData ? await processBangumiData(onHoldData, "onhold") : [];
	const droppedList = droppedData ? await processBangumiData(droppedData, "dropped") : [];

	animeList = [...watchingList, ...plannedList, ...completedList, ...onHoldList, ...droppedList];
}

function getStatusInfo(status: string) { /* ... */ }

// è®¡ç®—å…¨å±€ç»Ÿè®¡æ•°æ®ï¼ˆä¸åˆ†é¡µï¼‰
const stats = {
	total: animeList.length,
	watching: animeList.filter((anime) => anime.status === "watching").length,
	completed: animeList.filter((anime) => anime.status === "completed").length,
	planned: animeList.filter((anime) => anime.status === "planned").length,
	onhold: animeList.filter((anime) => anime.status === "onhold").length,
	dropped: animeList.filter((anime) => anime.status === "dropped").length,
	avgRating: (() => {
		const ratedAnime = animeList.filter((anime) => anime.rating > 0);
		if (ratedAnime.length === 0) return "0.0";
		return (
			ratedAnime.reduce((sum, anime) => sum + anime.rating, 0) /
			ratedAnime.length
		).toFixed(1);
	})(),
};

// åˆ†é¡µé…ç½®
const ITEMS_PER_PAGE = 12;
let currentPage = 1;
let filteredList = animeList; // åˆå§‹ä¸ºå…¨éƒ¨

// æ³¨æ„ï¼šAstro æ˜¯é™æ€çš„ï¼Œæ— æ³•åœ¨æœåŠ¡ç«¯å¤„ç†åˆ†é¡µäº¤äº’ï¼Œ
// å› æ­¤æˆ‘ä»¬å°†åˆ†é¡µé€»è¾‘æ”¾åœ¨å®¢æˆ·ç«¯ JS ä¸­å®ç°ï¼ˆé€šè¿‡ is:inline è„šæœ¬ï¼‰
// æ‰€ä»¥è¿™é‡Œä»…æä¾›åˆå§‹æ•°æ®ï¼Œåˆ†é¡µç”±å‰ç«¯æ§åˆ¶
---

<MainGridLayout title={i18n(I18nKey.anime)} description={i18n(I18nKey.animeSubtitle)}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="relative w-full mb-8">
        <div class="mb-6">
          <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                    before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
            {i18n(I18nKey.animeTitle)}
          </h1>
          <p class="text-black/75 dark:text-white/75">{i18n(I18nKey.animeSubtitle)}</p>
        </div>

        <!-- åŠ¨æ€ç»Ÿè®¡é¢æ¿ -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
          <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
            <div class="text-lg font-bold text-blue-600 dark:text-blue-400">{stats.total}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatsTotal)}</div>
          </div>
          <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
            <div class="text-lg font-bold text-green-600 dark:text-green-400">{stats.watching}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatusWatching)}</div>
          </div>
          <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
            <div class="text-lg font-bold text-blue-600 dark:text-blue-400">{stats.completed}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatusCompleted)}</div>
          </div>
          <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
            <div class="text-lg font-bold text-amber-600 dark:text-amber-400">{stats.planned}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatusPlanned)}</div>
          </div>
          {ANIME_MODE === 'bangumi' && (
            <>
              <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-purple-600 dark:text-purple-400">{stats.onhold}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatusOnHold)}</div>
              </div>
              <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center">
                <div class="text-lg font-bold text-red-600 dark:text-red-400">{stats.dropped}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatusDropped)}</div>
              </div>
            </>
          )}
          <div class="bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-lg p-3 text-center col-span-2 lg:col-span-1">
            <div class="text-lg font-bold text-yellow-600 dark:text-yellow-400">â˜… {stats.avgRating}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">{i18n(I18nKey.animeStatsAvgRating)}</div>
          </div>
        </div>

        <!-- è¿‡æ»¤æŒ‰é’® -->
        <div class="mb-6">
          <div class="filter-container flex flex-wrap gap-2">
            <button class="filter-tag active" data-status="all">{i18n(I18nKey.animeFilterAll)}</button>
            <button class="filter-tag" data-status="watching">{i18n(I18nKey.animeStatusWatching)}</button>
            <button class="filter-tag" data-status="planned">{i18n(I18nKey.animeStatusPlanned)}</button>
            <button class="filter-tag" data-status="completed">{i18n(I18nKey.animeStatusCompleted)}</button>
            {ANIME_MODE === 'bangumi' && (
              <>
                <button class="filter-tag" data-status="onhold">{i18n(I18nKey.animeStatusOnHold)}</button>
                <button class="filter-tag" data-status="dropped">{i18n(I18nKey.animeStatusDropped)}</button>
              </>
            )}
          </div>
        </div>
      </div>

      <!-- åŠ¨æ¼«åˆ—è¡¨å®¹å™¨ï¼ˆç”± JS æ§åˆ¶å†…å®¹ï¼‰ -->
      <div class="mb-8">
        {ANIME_MODE !== 'local' && BANGUMI_USER_ID === 'your-user-id' ? (
          <div class="text-center py-12">
            <div class="text-5xl mb-4">ğŸ˜¢</div>
            <h3 class="text-xl font-medium text-black/80 dark:text-white/80 mb-2">
              {i18n(I18nKey.animeEmpty)}
            </h3>
            <p class="text-black/60 dark:text-white/60">
              è¯·åœ¨ src/config.ts æ–‡ä»¶ä¸­è®¾ç½®ä½ çš„ Bangumi ç”¨æˆ·ID
            </p>
          </div>
        ) : animeList.length > 0 ? (
          <div id="anime-list-container" class={`anime-grid-container grid gap-4 md:gap-6 list-mode ${
            isBothSidebarMode ? "both-sidebar" : "single-sidebar"
          }`}>
            <!-- åˆ—è¡¨é¡¹å°†ç”± JS åŠ¨æ€æ’å…¥ -->
          </div>
        ) : (
          <div class="text-center py-12">
            <div class="text-5xl mb-4">ğŸ˜¢</div>
            <h3 class="text-xl font-medium text-black/80 dark:text-white/80 mb-2">
              {i18n(I18nKey.animeEmpty)}
            </h3>
            <p class="text-black/60 dark:text-white/60">
              {ANIME_MODE === 'local' ? i18n(I18nKey.animeEmptyLocal) : i18n(I18nKey.animeEmptyBangumi)}
            </p>
          </div>
        )}

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="pagination-controls" class="mt-8 flex justify-center items-center gap-2 hidden">
          <button id="prev-page" class="px-3 py-1.5 rounded-md bg-[var(--btn-regular-bg)] text-sm disabled:opacity-50" disabled>
            â† {i18n(I18nKey.prevPage)}
          </button>
          <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400"></span>
          <button id="next-page" class="px-3 py-1.5 rounded-md bg-[var(--btn-regular-bg)] text-sm disabled:opacity-50">
            {i18n(I18nKey.nextPage)} â†’
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å†…è”è„šæœ¬ï¼šåŒ…å«åˆ†é¡µ + è¿‡æ»¤ + å¸ƒå±€ç®¡ç† -->
  <script is:inline define:vars={{ 
    animeList, 
    isBothSidebarMode, 
    ITEMS_PER_PAGE,
    i18nKeys: {
      prevPage: i18n(I18nKey.prevPage),
      nextPage: i18n(I18nKey.nextPage)
    }
  }}>
  (function() {
    const animeList = JSON.parse(JSON.stringify({animeList}));
    let currentFilter = 'all';
    let currentPage = 1;
    const ITEMS_PER_PAGE = {ITEMS_PER_PAGE};

    const container = document.getElementById('anime-list-container');
    const paginationEl = document.getElementById('pagination-controls');
    const pageInfoEl = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    // æ¸²æŸ“æŒ‡å®šé¡µçš„åˆ—è¡¨
    function renderPage(page, list) {
      const start = (page - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageItems = list.slice(start, end);

      container.innerHTML = '';
      pageItems.forEach(anime => {
        const statusInfo = getStatusInfo(anime.status);
        const progressPercent = anime.totalEpisodes > 0 ? (anime.progress / anime.totalEpisodes) * 100 : 0;

        const card = document.createElement('div');
        card.className = `group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden transition-all duration-300 hover:shadow-lg hover:scale-[1.02]`;
        card.setAttribute('data-anime-status', anime.status);
        card.innerHTML = `
          <div class="relative aspect-[2/3] overflow-hidden">
            <a href="${anime.link}" target="_blank" rel="noopener noreferrer" class="block w-full h-full">
              <img src="${anime.cover}" alt="${anime.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center">
                    <svg class="w-6 h-6 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
              </div>
            </a>
            <div class="absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}">
              <span class="mr-1">${statusInfo.icon}</span>
              <span>${statusInfo.text}</span>
            </div>
            <div class="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1">
              <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
              <span>${anime.rating}</span>
            </div>
            ${anime.status === 'watching' ? `
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                <div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
                  <div class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-white text-xs font-medium">
                  ${anime.progress}/${anime.totalEpisodes} (${Math.round(progressPercent)}%)
                </div>
              </div>
            ` : ''}
          </div>
          <div class="p-3">
            <h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 line-clamp-2 leading-tight">${anime.title}</h3>
            <p class="text-black/60 dark:text-white/60 text-xs mb-2 line-clamp-2">${anime.description || ''}</p>
            <div class="space-y-1 text-xs">
              <div class="flex justify-between">
                <span class="text-black/50 dark:text-white/50">å¹´ä»½</span>
                <span class="text-black/70 dark:text-white/70">${anime.year}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-black/50 dark:text-white/50">åˆ¶ä½œ</span>
                <span class="text-black/70 dark:text-white/70 truncate ml-2">${anime.studio}</span>
              </div>
              <div class="flex flex-wrap gap-1 mt-2">
                ${(anime.genre || []).map(g => `<span class="px-1.5 py-0.5 bg-[var(--btn-regular-bg)] text-black/70 dark:text-white/70 rounded text-xs">${g}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      // æ›´æ–°å¸ƒå±€ï¼ˆFLIP åŠ¨ç”»å·²åœ¨åŸè„šæœ¬ä¸­å¤„ç†ï¼‰
      if (typeof window.layoutManager !== 'undefined') {
        window.layoutManager.checkScreenSizeAndAdjust();
      }
    }

    // è·å–è¿‡æ»¤åçš„åˆ—è¡¨
    function getFilteredList() {
      return currentFilter === 'all' 
        ? animeList 
        : animeList.filter(a => a.status === currentFilter);
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶
    function updatePagination() {
      const filtered = getFilteredList();
      const totalPages = Math.max(1, Math.ceil(filtered.length / ITEMS_PER_PAGE));
      
      // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
      paginationEl.classList.toggle('hidden', totalPages <= 1);

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      
      pageInfoEl.textContent = `${currentPage} / ${totalPages}`;

      // æ¸²æŸ“å½“å‰é¡µ
      renderPage(currentPage, filtered);
    }

    // çŠ¶æ€æ˜ å°„ï¼ˆç”¨äºç¿»è¯‘ï¼‰
    function getStatusInfo(status) {
      const i18n = (key) => {
        const map = {
          watching: "åœ¨çœ‹",
          completed: "çœ‹è¿‡",
          planned: "æƒ³çœ‹",
          onhold: "æç½®",
          dropped: "æŠ›å¼ƒ"
        };
        return map[key] || key;
      };
      const classes = {
        watching: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
        completed: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
        planned: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
        onhold: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300",
        dropped: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"
      };
      const icons = { watching: "â–¶", completed: "âœ“", planned: "â°", onhold: "â¸", dropped: "âœ—" };
      return {
        text: i18n(status),
        class: classes[status] || "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
        icon: icons[status] || "?"
      };
    }

    // åˆå§‹åŒ–è¿‡æ»¤æŒ‰é’®
    function initFilterButtons() {
      document.querySelectorAll('.filter-tag').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          currentPage = 1; // é‡ç½®é¡µç 
          updatePagination();
        });
      });
    }

    // ç»‘å®šåˆ†é¡µäº‹ä»¶
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
      }
    });
    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(getFilteredList().length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
      }
    });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initFilterButtons();
      updatePagination();

      // å…¼å®¹ Swup
      if (window.swup) {
        window.swup.hooks.on('content:replace', () => {
          setTimeout(() => {
            initFilterButtons();
            updatePagination();
          }, 150);
        });
      }
    });
  })();
  </script>

  <!-- æ ·å¼ä¿æŒä¸å˜ -->
  <style>
    .card-base { container-type: inline-size; }
    
    .anime-grid-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .anime-grid-container.single-sidebar {
      @container (min-width: 900px) { grid-template-columns: repeat(5, 1fr); }
      @container (min-width: 600px) and (max-width: 899px) { grid-template-columns: repeat(3, 1fr); }
      @container (max-width: 599px) { grid-template-columns: repeat(2, 1fr); }
    }
    
    .anime-grid-container.both-sidebar {
      @container (min-width: 950px) { grid-template-columns: repeat(5, 1fr); }
      @container (min-width: 650px) and (max-width: 949px) { grid-template-columns: repeat(4, 1fr); }
      @container (min-width: 480px) and (max-width: 649px) { grid-template-columns: repeat(3, 1fr); }
      @container (max-width: 479px) { grid-template-columns: repeat(2, 1fr); }
    }
    
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .filter-tag {
      padding: 0.5rem 1rem;
      border: 1px solid var(--line-divider);
      border-radius: var(--radius-large);
      background: var(--btn-regular-bg);
      color: var(--btn-content);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .filter-tag:hover:not(.active) {
      background: var(--btn-hover-bg);
      border-color: var(--primary);
      transform: translateY(-1px);
    }
    
    .filter-tag.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .filter-tag.active:hover {
      background: var(--primary) !important;
      color: white !important;
      border-color: var(--primary) !important;
      transform: translateY(-1px);
    }
    
    [data-anime-status] {
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #anime-list-container.grid-mode [data-anime-status]:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }
    
    #anime-list-container.list-mode [data-anime-status]:hover {
      transform: translateX(8px) scale(1.01);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    
    [data-anime-status].anime-hidden { display: none; }
    [data-anime-status].anime-fade-out {
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
    }
  </style>
</MainGridLayout>
